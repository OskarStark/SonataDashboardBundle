/**
 *
 * This file is part of the Sonata package.
 *
 * (c) Thomas Rabaix <thomas.rabaix@sonata-project.org>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 *
 * generated on: Tue Aug 04 2015 17:55:41 GMT+0200 (CEST)
 * revision:     aa78a0619f906811d290a418c0728a8c1e5b678b
 *
 */
!function(e,o){function n(e){"undefined"==typeof o.admin&&Admin.shared_setup(e)}var a=function(o,n){var a=n||{};this.dashboardId=o,this.$container=e(".dashboard-composer"),this.$dynamicArea=e(".dashboard-composer__dyn-content"),this.$dashboardPreview=e(".dashboard-composer__dashboard-preview"),this.$containerPreviews=this.$dashboardPreview.find(".dashboard-composer__dashboard-preview__container"),this.$containersArea=this.$dashboardPreview.find(".dashboard-composer__dashboard-preview__containers"),this.routes=e.extend({},a.routes||{}),this.translations=e.extend({},a.translations||{}),this.csrfTokens={},this.bindDashboardPreviewHandlers(),this.bindAddContainer();var t=this,r=e(this);r.on("containerclick",function(e){t.loadContainer(e.$container)}),r.on("containerloaded",this.handleContainerLoaded),r.on("blockcreated",this.handleBlockCreated),r.on("blockremoved",this.handleBlockRemoved),r.on("blockcreateformloaded",this.handleBlockCreateFormLoaded),r.on("blockpositionsupdate",this.handleBlockPositionsUpdate),r.on("blockeditformloaded",this.handleBlockEditFormLoaded),r.on("blockparentswitched",this.handleBlockParentSwitched),r.on("blockcontainerformloaded",this.handleContainerEditFormLoaded)};a.prototype={translate:function(e){return this.translations[e]?this.translations[e]:e},getRouteUrl:function(e,o){if(!this.routes[e])throw new Error('Route "'+e+'" does not exist');var n=this.routes[e];for(var a in o)n=n.replace(new RegExp(a),o[a]);return n},isFormControlTypeByName:function(e,o){if("undefined"!=typeof e){var n=e.length,a="["+o+"]",t=e.lastIndexOf(a),n=n-a.length;return-1!==t&&t===n}return!1},handleBlockCreated:function(o){var n=this;e.ajax({url:this.getRouteUrl("block_preview",{BLOCK_ID:o.blockId}),type:"GET",success:function(a){var t=e(a);o.$childBlock.replaceWith(t),n.controlChildBlock(t);var r=n.getContainerChildCountFromList(o.parentId);null!==r&&n.updateChildCount(o.parentId,r)},error:function(){n.containerNotification("an error occured while fetching block preview","error",!0)}})},handleBlockRemoved:function(e){var o=this.getContainerChildCountFromList(e.parentId);null!==o&&this.updateChildCount(e.parentId,o)},containerNotification:function(o,n,a){var t=this.$dynamicArea.find(".dashboard-composer__container__view__notice");if(1===t.length)if(this.containerNotificationTimer&&clearTimeout(this.containerNotificationTimer),t.removeClass("persist success error"),n&&t.addClass(n),t.text(o),t.show(),a!==!0)this.containerNotificationTimer=setTimeout(function(){t.hide().empty()},2e3);else{var r=e('<span class="close-notice">x</span>');r.on("click",function(){t.hide().empty()}),t.addClass("persist"),t.append(r)}},handleBlockPositionsUpdate:function(o){var n=this;this.containerNotification("saving block positionsâ€¦"),e.ajax({url:this.getRouteUrl("save_blocks_positions"),type:"POST",data:{disposition:o.disposition},success:function(e){e.result&&"ok"===e.result&&n.containerNotification("block positions saved","success")},error:function(){n.containerNotification("an error occured while saving block positions","error",!0)}})},handleBlockParentSwitched:function(o){var n=e(".block-preview-"+o.previousParentId),a=n.find(".child-count"),t=parseInt(a.text().trim(),10),r=e(".block-preview-"+o.newParentId),i=r.find(".child-count"),d=parseInt(i.text().trim(),10);this.updateChildCount(o.previousParentId,t-1),this.updateChildCount(o.newParentId,d+1)},getContainerChildCountFromList:function(o){var n=this.$dynamicArea.find(".block-view-"+o);if(0===n.length)return null;var a=n.find(".dashboard-composer__container__child"),t=0;return a.each(function(){var o=e(this),n=o.attr("data-block-id");"undefined"!=typeof n&&t++}),t},updateChildCount:function(o,n){var a=e(".block-preview-"+o),t=e(".block-view-"+o);a.length>0&&a.find(".child-count").text(n),t.length>0&&t.find(".dashboard-composer__container__child-count span").text(n)},handleBlockCreateFormLoaded:function(o){var a=this,t=this.$dynamicArea.find(".dashboard-composer__container__children"),r=this.$dynamicArea.find(".dashboard-composer__container__main-edition-area");if(o.container){var i=o.container,d=i.find(".dashboard-composer__container__child__content");d.html(o.response)}else{var i=e(['<li class="dashboard-composer__container__child">','<a class="dashboard-composer__container__child__edit">','<h4 class="dashboard-composer__container__child__name">','<input type="text" class="dashboard-composer__container__child__name__input">',"</h4>","</a>",'<div class="dashboard-composer__container__child__right">','<span class="badge">'+o.blockTypeLabel+"</span>","</div>",'<div class="dashboard-composer__container__child__content">',"</div>","</li>"].join("")),d=i.find(".dashboard-composer__container__child__content");d.append(o.response),t.append(i),d.show()}var c,s,l,_=i.find("form"),h=_.attr("action"),p=_.attr("method"),f=_.find("input, select, textarea"),u=_.find(".form-actions"),m=this.$dynamicArea.find(".dashboard-composer__container__child__name");n(_),e(document).scrollTo(i,200),r.show(),f.each(function(){var n=e(this),r=n.attr("name");a.isFormControlTypeByName(r,"name")?(c=n,m.find(".dashboard-composer__container__child__name__input").bind("propertychange keyup input paste",function(o){c.val(e(this).val())})):a.isFormControlTypeByName(r,"parent")?(s=n,s.val(o.containerId),s.parent().parent().hide()):a.isFormControlTypeByName(r,"position")&&(l=n,l.val(t.find("> *").length),l.closest(".form-group").hide())}),u.each(function(){var o=e(this),n=e('<span class="btn btn-warning">'+a.translate("cancel")+"</span>");n.on("click",function(o){o.preventDefault(),i.remove(),e(document).scrollTo(a.$dynamicArea,200)}),o.append(n)}),_.on("submit",function(t){t.preventDefault();var r=c.val();return""===r&&(r=o.blockType),e.ajax({url:h+"&"+e.param({composer:1}),data:_.serialize(),type:p,success:function(t){if(t.result&&"ok"===t.result&&t.objectId){var c=e.Event("blockcreated");c.$childBlock=i,c.parentId=o.containerId,c.blockId=t.objectId,c.blockName=r,c.blockType=o.blockType,e(a).trigger(c)}else{var s=e.Event("blockcreateformloaded");s.response=t,s.containerId=o.containerId,s.blockType=o.blockType,s.container=i,e(a).trigger(s),n(d)}}}),!1})},toggleChildBlock:function(e){var o="dashboard-composer__container__child--expanded",n=this.$dynamicArea.find(".dashboard-composer__container__child"),a=e.find(".dashboard-composer__container__child__name"),t=a.find(".dashboard-composer__container__child__name__input");e.hasClass(o)?(e.removeClass(o),a.has(".dashboard-composer__container__child__name__input")&&a.html(t.val())):(n.not(e).removeClass(o),e.addClass(o))},handleBlockEditFormLoaded:function(o){var a,t,r=this,i=o.$block.find(".dashboard-composer__container__child__edit h4"),d=o.$block.find(".dashboard-composer__container__child__content"),c=o.$block.find(".dashboard-composer__container__child__loader"),s=d.find("form"),l=s.attr("action"),_=s.attr("method"),h=o.$block.find(".dashboard-composer__container__child__edit small").text().trim();s.find("input").each(function(){var o=e(this),n=o.attr("name");r.isFormControlTypeByName(n,"name")?(a=o,i.html('<input type="text" class="dashboard-composer__container__child__name__input" value="'+i.text()+'">'),$input=i.find("input"),$input.bind("propertychange keyup input paste",function(e){a.val($input.val())}),$input.on("click",function(e){e.stopPropagation(),e.preventDefault()})):r.isFormControlTypeByName(n,"position")&&(t=o,t.closest(".form-group").hide())}),s.on("submit",function(t){return t.preventDefault(),c.show(),e.ajax({url:l,data:s.serialize(),type:_,success:function(t){if(c.hide(),t.result&&"ok"===t.result)"undefined"!=typeof a&&i.text(""!==a.val()?a.val():h),o.$block.removeClass("dashboard-composer__container__child--expanded"),d.empty();else{d.html(t);var s=e.Event("blockeditformloaded");s.$block=o.$block,e(r).trigger(s),n(d)}}}),!1})},controlChildBlock:function(o){var a=this,t=o.find(".dashboard-composer__container__child__content"),r=o.find(".dashboard-composer__container__child__loader"),i=o.find(".dashboard-composer__container__child__edit"),d=i.attr("href"),c=o.find(".dashboard-composer__container__child__remove"),s=c.find("a"),l=c.find(".dashboard-composer__container__child__remove__confirm"),_=l.find(".cancel"),h=l.find(".yes"),p=s.attr("href"),f=o.find(".dashboard-composer__container__child__switch-enabled"),u=f.attr("data-label-enable"),m=f.attr("data-label-disable"),b=f.find("a"),v=b.find("i"),k=o.find(".dashboard-composer__container__child__enabled"),g=k.find("small"),y=k.find("i"),w=b.attr("href"),C=parseInt(o.attr("data-block-enabled"),2);parentId=parseInt(o.attr("data-parent-block-id"),10),i.click(function(i){return i.preventDefault(),t.find("form").length>0?void a.toggleChildBlock(o):(r.show(),void e.ajax({url:d,success:function(i){t.html(i);var d=e.Event("blockeditformloaded");d.$block=o,e(a).trigger(d),n(t),r.hide(),a.toggleChildBlock(o)}}))}),b.on("click",function(n){n.preventDefault(),e.ajax({url:w,type:"POST",data:{_sonata_csrf_token:a.csrfTokens.switchEnabled,enabled:!C},success:function(n){if(n.status&&"OK"===n.status){if(o.attr("data-parent-block-enabled",!C),C=!C,b.toggleClass("bg-yellow bg-green"),v.toggleClass("fa-toggle-off fa-toggle-on"),b.html(C?m:u),g.toggleClass("bg-yellow bg-green"),y.toggleClass("fa-times fa-check"),o.has("form")){var t=o.find("form"),r=t.find("input");r.each(function(){var o=e(this),n=o.attr("name");a.isFormControlTypeByName(n,"enabled")&&o.val(parseInt(!C))})}}else a.containerNotification("an error occured while saving block enabled status","error",!0)},error:function(){a.containerNotification("an error occured while saving block enabled status","error",!0)}})}),s.on("click",function(e){e.preventDefault(),s.hide(),l.show()}),h.on("click",function(n){n.preventDefault(),e.ajax({url:p,type:"POST",data:{_method:"DELETE",_sonata_csrf_token:a.csrfTokens.remove},success:function(n){if(n.result&&"ok"===n.result){o.remove();var t=e.Event("blockremoved");t.parentId=parentId,e(a).trigger(t)}}})}),_.on("click",function(e){e.preventDefault(),l.hide(),s.show()})},handleContainerLoaded:function(o){var a=this,t=this.$dynamicArea.find(".dashboard-composer__container__children"),r=this.$dynamicArea.find(".dashboard-composer__container__child"),i=this.$dynamicArea.find(".dashboard-composer__block-type-selector"),d=i.find(".dashboard-composer__block-type-selector__loader"),c=i.find("select"),s=i.find(".dashboard-composer__block-type-selector__confirm"),l=this.$dynamicArea.find(".dashboard-composer__container__view__loader"),_=this.$dynamicArea.find(".dashboard-composer__container__settings"),h=this.$dynamicArea.find(".dashboard-composer__container__settings__content"),p=this.$dynamicArea.find(".dashboard-composer__container__view__cogs .btn"),f=_.data("href"),u=s.attr("href"),m=this.$dynamicArea.find(".dashboard-composer__container__settings__right__remove"),b=m.find("a"),v=m.find(".dashboard-composer__container__settings__right__remove__confirm"),k=v.find(".cancel"),g=v.find(".yes"),y=b.attr("href"),w=this.$containersArea.find(".dashboard-composer__dashboard-preview__container.active");n(this.$dynamicArea),s.on("click",function(n){n.preventDefault(),d.css("display","inline-block");var t=c.val(),r=c.find("option:selected").text();e.ajax({url:u,data:{type:t},success:function(n){d.hide(),e(a).trigger(e.Event("blockcreateformloaded",{response:n,containerId:o.containerId,blockType:t,blockTypeLabel:r}))}})}),t.sortable({revert:!0,cursor:"move",revertDuration:200,delay:200,helper:function(o,n){{var a=e(n),t=a.find(".dashboard-composer__container__child__edit h4").text().trim();a.find(".dashboard-composer__container__child__edit small").text().trim()}return a.removeClass("dashboard-composer__container__child--expanded"),e('<div class="dashboard-composer__container__child__helper"><h4>'+t+"</h4></div>")},update:function(o,n){var r=[];if(t.find(".dashboard-composer__container__child").each(function(o){var n=e(this),t=n.attr("data-parent-block-id"),i=n.attr("data-block-id");"undefined"!=typeof i&&r.push({id:parseInt(i,10),position:o,parent_id:parseInt(t,10),dashboard_id:a.dashboardId})}),r.length>0){var i=e.Event("blockpositionsupdate");i.disposition=r,e(a).trigger(i)}}}),b.on("click",function(e){e.preventDefault(),b.hide(),v.show()}),g.on("click",function(o){o.preventDefault(),e.ajax({url:y,type:"POST",data:{_method:"DELETE",_sonata_csrf_token:a.csrfTokens.remove},success:function(e){e.result&&"ok"===e.result&&(w.remove(),a.$containerPreviews=a.$dashboardPreview.find(".dashboard-composer__dashboard-preview__container"),a.$dynamicArea.empty(),a.bindDashboardPreviewHandlers())}})}),k.on("click",function(e){e.preventDefault(),v.hide(),b.show()}),p.on("click",function(o){l.show(),e.ajax({url:f,success:function(o){l.hide(),h.html(o);var t=e.Event("blockcontainerformloaded");e(a).trigger(t),n(w),_.toggle()}})}),r.each(function(){a.controlChildBlock(e(this))})},bindDashboardPreviewHandlers:function(o){var n=this;this.$containerPreviews.each(function(){var o=e(this);o.unbind().on("click",function(a){a.preventDefault();var t=e.Event("containerclick");t.$container=o,e(n).trigger(t)})}).droppable({hoverClass:"hover",tolerance:"pointer",revert:!0,connectToSortable:".dashboard-composer__container__children",drop:function(o,a){var t=a.draggable.attr("data-block-id");if("undefined"!=typeof t){a.helper.remove();var r=e(this),i=parseInt(a.draggable.attr("data-parent-block-id"),10),d=parseInt(r.attr("data-block-id"),10);t=parseInt(t,10),i!==d&&(r.addClass("dropped"),r.on("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(e){r.removeClass("dropped")}),e.ajax({url:n.getRouteUrl("block_switch_parent"),data:{block_id:t,parent_id:d},success:function(o){if(o.result&&"ok"===o.result){a.draggable.remove();var r=e.Event("blockparentswitched");r.previousParentId=i,r.newParentId=d,r.blockId=t,e(n).trigger(r)}}}))}}}),this.$containerPreviews.length>0&&this.loadContainer(void 0==o?this.$containerPreviews.eq(0):this.$containerPreviews.eq(o))},loadContainer:function(o){var n=o.attr("href"),a=o.attr("data-block-id"),t=this;this.$dynamicArea.empty(),this.$containerPreviews.removeClass("active"),o.addClass("active"),e.ajax({url:n,success:function(o){t.$dynamicArea.html(o),e(document).scrollTo(t.$dynamicArea,200,{offset:{top:-100}});var n=e.Event("containerloaded");n.containerId=a,e(t).trigger(n)}})},bindAddContainer:function(){var o=this,n=this.$dashboardPreview.find(".dashboard-composer__block-container-header"),a=n.find(".dashboard-composer__block-container-header__loader"),t=n.find("input"),r=n.find(".dashboard-composer__block-container-header__confirm"),i=r.attr("href");r.on("click",function(n){n.preventDefault(),a.css("display","inline-block");var r=t.val();e.ajax({url:i,data:{name:r},success:function(e){a.hide(),t.val(""),o.$containersArea.append(e),o.$containerPreviews=o.$dashboardPreview.find(".dashboard-composer__dashboard-preview__container"),o.bindDashboardPreviewHandlers(o.$containerPreviews.length-1)}})})},handleContainerEditFormLoaded:function(o){var a=this,t=this.$dynamicArea.find(".dashboard-composer__container__settings"),r=t.find(".dashboard-composer__container__settings__content"),i=this.$containersArea.find(".dashboard-composer__dashboard-preview__container.active"),d=i.find("strong"),c=this.$dynamicArea.find(".dashboard-composer__container__view__loader"),s=r.find("form"),l=s.attr("action"),_=s.attr("method");s.on("submit",function(o){return o.preventDefault(),c.show(),e.ajax({url:l+"&"+e.param({composer:1}),data:s.serialize(),type:_,success:function(o){if(c.hide(),o.result&&"ok"===o.result&&o.objectId&&o.objectName)t.toggle(),d.html(o.objectName),a.loadContainer(a.$containerPreviews.eq(i.index()));else{var r=e.Event("blockcontainerformloaded");r.response=o,e(a).trigger(r),n(i)}}}),!1})}},o.DashboardComposer=a}(jQuery,window);