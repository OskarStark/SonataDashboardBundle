/**
 *
 * This file is part of the Sonata package.
 *
 * (c) Thomas Rabaix <thomas.rabaix@sonata-project.org>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 *
 * generated on: Mon Aug 03 2015 17:45:58 GMT+0200 (CEST)
 * revision:     08f66c7292604514973dc3dbdf10f00c0882dc0e
 *
 */
!function(e,n){function o(e){"undefined"==typeof n.admin&&Admin.shared_setup(e)}var a=function(n,o){var a=o||{};this.dashboardId=n,this.$container=e(".dashboard-composer"),this.$dynamicArea=e(".dashboard-composer__dyn-content"),this.$dashboardPreview=e(".dashboard-composer__dashboard-preview"),this.$containerPreviews=this.$dashboardPreview.find(".dashboard-composer__dashboard-preview__container"),this.$containersArea=this.$dashboardPreview.find(".dashboard-composer__dashboard-preview__containers"),this.routes=e.extend({},a.routes||{}),this.translations=e.extend({},a.translations||{}),this.csrfTokens={},this.bindDashboardPreviewHandlers(),this.bindAddContainer();var t=this,r=e(this);r.on("containerclick",function(e){t.loadContainer(e.$container)}),r.on("containerloaded",this.handleContainerLoaded),r.on("blockcreated",this.handleBlockCreated),r.on("blockremoved",this.handleBlockRemoved),r.on("blockcreateformloaded",this.handleBlockCreateFormLoaded),r.on("blockpositionsupdate",this.handleBlockPositionsUpdate),r.on("blockeditformloaded",this.handleBlockEditFormLoaded),r.on("blockparentswitched",this.handleBlockParentSwitched)};a.prototype={translate:function(e){return this.translations[e]?this.translations[e]:e},getRouteUrl:function(e,n){if(!this.routes[e])throw new Error('Route "'+e+'" does not exist');var o=this.routes[e];for(var a in n)o=o.replace(new RegExp(a),n[a]);return o},isFormControlTypeByName:function(e,n){if("undefined"!=typeof e){var o=e.length,a="["+n+"]",t=e.lastIndexOf(a),o=o-a.length;return-1!==t&&t===o}return!1},handleBlockCreated:function(n){var o=this;e.ajax({url:this.getRouteUrl("block_preview",{BLOCK_ID:n.blockId}),type:"GET",success:function(a){var t=e(a);n.$childBlock.replaceWith(t),o.controlChildBlock(t);var r=o.getContainerChildCountFromList(n.parentId);null!==r&&o.updateChildCount(n.parentId,r)},error:function(){o.containerNotification("an error occured while fetching block preview","error",!0)}})},handleBlockRemoved:function(e){var n=this.getContainerChildCountFromList(e.parentId);null!==n&&this.updateChildCount(e.parentId,n)},containerNotification:function(n,o,a){var t=this.$dynamicArea.find(".dashboard-composer__container__view__notice");if(1===t.length)if(this.containerNotificationTimer&&clearTimeout(this.containerNotificationTimer),t.removeClass("persist success error"),o&&t.addClass(o),t.text(n),t.show(),a!==!0)this.containerNotificationTimer=setTimeout(function(){t.hide().empty()},2e3);else{var r=e('<span class="close-notice">x</span>');r.on("click",function(){t.hide().empty()}),t.addClass("persist"),t.append(r)}},handleBlockPositionsUpdate:function(n){var o=this;this.containerNotification("saving block positionsâ€¦"),e.ajax({url:this.getRouteUrl("save_blocks_positions"),type:"POST",data:{disposition:n.disposition},success:function(e){e.result&&"ok"===e.result&&o.containerNotification("block positions saved","success")},error:function(){o.containerNotification("an error occured while saving block positions","error",!0)}})},handleBlockParentSwitched:function(n){var o=e(".block-preview-"+n.previousParentId),a=o.find(".child-count"),t=parseInt(a.text().trim(),10),r=e(".block-preview-"+n.newParentId),i=r.find(".child-count"),d=parseInt(i.text().trim(),10);this.updateChildCount(n.previousParentId,t-1),this.updateChildCount(n.newParentId,d+1)},getContainerChildCountFromList:function(n){var o=this.$dynamicArea.find(".block-view-"+n);if(0===o.length)return null;var a=o.find(".dashboard-composer__container__child"),t=0;return a.each(function(){var n=e(this),o=n.attr("data-block-id");"undefined"!=typeof o&&t++}),t},updateChildCount:function(n,o){var a=e(".block-preview-"+n),t=e(".block-view-"+n);a.length>0&&a.find(".child-count").text(o),t.length>0&&t.find(".dashboard-composer__container__child-count span").text(o)},handleBlockCreateFormLoaded:function(n){var a=this,t=this.$dynamicArea.find(".dashboard-composer__container__children"),r=this.$dynamicArea.find(".dashboard-composer__container__main-edition-area");if(n.container){var i=n.container,d=i.find(".dashboard-composer__container__child__content");d.html(n.response)}else{var i=e(['<li class="dashboard-composer__container__child">','<a class="dashboard-composer__container__child__edit">','<h4 class="dashboard-composer__container__child__name">','<input type="text" class="dashboard-composer__container__child__name__input">',"</h4>","</a>",'<div class="dashboard-composer__container__child__right">','<span class="badge">'+n.blockTypeLabel+"</span>","</div>",'<div class="dashboard-composer__container__child__content">',"</div>","</li>"].join("")),d=i.find(".dashboard-composer__container__child__content");d.append(n.response),t.append(i),d.show()}var c,s,l,h=i.find("form"),_=h.attr("action"),p=h.attr("method"),f=h.find("input, select, textarea"),u=h.find(".form-actions"),m=this.$dynamicArea.find(".dashboard-composer__container__child__name");o(h),e(document).scrollTo(i,200),r.show(),f.each(function(){var o=e(this),r=o.attr("name");a.isFormControlTypeByName(r,"name")?(c=o,m.find(".dashboard-composer__container__child__name__input").bind("propertychange keyup input paste",function(n){c.val(e(this).val())})):a.isFormControlTypeByName(r,"parent")?(s=o,s.val(n.containerId),s.parent().parent().hide()):a.isFormControlTypeByName(r,"position")&&(l=o,l.val(t.find("> *").length),l.closest(".form-group").hide())}),u.each(function(){var n=e(this),o=e('<span class="btn btn-warning">'+a.translate("cancel")+"</span>");o.on("click",function(n){n.preventDefault(),i.remove(),e(document).scrollTo(a.$dynamicArea,200)}),n.append(o)}),h.on("submit",function(t){t.preventDefault();var r=c.val();return""===r&&(r=n.blockType),e.ajax({url:_+"&"+e.param({composer:1}),data:h.serialize(),type:p,success:function(t){if(t.result&&"ok"===t.result&&t.objectId){var c=e.Event("blockcreated");c.$childBlock=i,c.parentId=n.containerId,c.blockId=t.objectId,c.blockName=r,c.blockType=n.blockType,e(a).trigger(c)}else{var s=e.Event("blockcreateformloaded");s.response=t,s.containerId=n.containerId,s.blockType=n.blockType,s.container=i,e(a).trigger(s),o(d)}}}),!1})},toggleChildBlock:function(e){var n="dashboard-composer__container__child--expanded",o=this.$dynamicArea.find(".dashboard-composer__container__child"),a=e.find(".dashboard-composer__container__child__name"),t=a.find(".dashboard-composer__container__child__name__input");e.hasClass(n)?(e.removeClass(n),a.has(".dashboard-composer__container__child__name__input")&&a.html(t.val())):(o.not(e).removeClass(n),e.addClass(n))},handleBlockEditFormLoaded:function(n){var a,t,r=this,i=n.$block.find(".dashboard-composer__container__child__edit h4"),d=n.$block.find(".dashboard-composer__container__child__content"),c=n.$block.find(".dashboard-composer__container__child__loader"),s=d.find("form"),l=s.attr("action"),h=s.attr("method"),_=n.$block.find(".dashboard-composer__container__child__edit small").text().trim();s.find("input").each(function(){var n=e(this),o=n.attr("name");r.isFormControlTypeByName(o,"name")?(a=n,i.html('<input type="text" class="dashboard-composer__container__child__name__input" value="'+i.text()+'">'),$input=i.find("input"),$input.bind("propertychange keyup input paste",function(e){a.val($input.val())}),$input.on("click",function(e){e.stopPropagation(),e.preventDefault()})):r.isFormControlTypeByName(o,"position")&&(t=n,t.closest(".form-group").hide())}),s.on("submit",function(t){return t.preventDefault(),c.show(),e.ajax({url:l,data:s.serialize(),type:h,success:function(t){if(c.hide(),t.result&&"ok"===t.result)"undefined"!=typeof a&&i.text(""!==a.val()?a.val():_),n.$block.removeClass("dashboard-composer__container__child--expanded"),d.empty();else{d.html(t);var s=e.Event("blockeditformloaded");s.$block=n.$block,e(r).trigger(s),o(d)}}}),!1})},controlChildBlock:function(n){var a=this,t=n.find(".dashboard-composer__container__child__content"),r=n.find(".dashboard-composer__container__child__loader"),i=n.find(".dashboard-composer__container__child__edit"),d=i.attr("href"),c=n.find(".dashboard-composer__container__child__remove"),s=c.find("a"),l=c.find(".dashboard-composer__container__child__remove__confirm"),h=l.find(".cancel"),_=l.find(".yes"),p=s.attr("href"),f=n.find(".dashboard-composer__container__child__switch-enabled"),u=f.attr("data-label-enable"),m=f.attr("data-label-disable"),b=f.find("a"),v=b.find("i"),k=n.find(".dashboard-composer__container__child__enabled"),g=k.find("small"),y=k.find("i"),w=b.attr("href"),C=parseInt(n.attr("data-parent-block-enabled"),1);parentId=parseInt(n.attr("data-parent-block-id"),10),i.click(function(i){return i.preventDefault(),t.find("form").length>0?void a.toggleChildBlock(n):(r.show(),void e.ajax({url:d,success:function(i){t.html(i);var d=e.Event("blockeditformloaded");d.$block=n,e(a).trigger(d),o(t),r.hide(),a.toggleChildBlock(n)}}))}),b.on("click",function(o){o.preventDefault(),e.ajax({url:w,type:"POST",data:{_sonata_csrf_token:a.csrfTokens.switchEnabled,enabled:!C},success:function(o){if(o.status&&"OK"===o.status){if(n.attr("data-parent-block-enabled",!C),C=!C,b.toggleClass("bg-yellow bg-green"),v.toggleClass("fa-toggle-off fa-toggle-on"),b.html(C?m:u),g.toggleClass("bg-yellow bg-green"),y.toggleClass("fa-times fa-check"),n.has("form")){var t=n.find("form"),r=t.find("input");r.each(function(){var n=e(this),o=n.attr("name");a.isFormControlTypeByName(o,"enabled")&&n.val(parseInt(!C))})}}else a.containerNotification("an error occured while saving block enabled status","error",!0)},error:function(){a.containerNotification("an error occured while saving block enabled status","error",!0)}})}),s.on("click",function(e){e.preventDefault(),s.hide(),l.show()}),_.on("click",function(o){o.preventDefault(),e.ajax({url:p,type:"POST",data:{_method:"DELETE",_sonata_csrf_token:a.csrfTokens.remove},success:function(o){if(o.result&&"ok"===o.result){n.remove();var t=e.Event("blockremoved");t.parentId=parentId,e(a).trigger(t)}}})}),h.on("click",function(e){e.preventDefault(),l.hide(),s.show()})},handleContainerLoaded:function(n){var a=this,t=this.$dynamicArea.find(".dashboard-composer__container__children"),r=this.$dynamicArea.find(".dashboard-composer__container__child"),i=this.$dynamicArea.find(".dashboard-composer__block-type-selector"),d=i.find(".dashboard-composer__block-type-selector__loader"),c=i.find("select"),s=i.find(".dashboard-composer__block-type-selector__confirm"),l=this.$dynamicArea.find(".dashboard-composer__container__settings"),h=this.$dynamicArea.find(".dashboard-composer__container__view__header .fa-cogs"),_=s.attr("href"),p=this.$dynamicArea.find(".dashboard-composer__container__settings__right__remove"),f=p.find("a"),u=p.find(".dashboard-composer__container__settings__right__remove__confirm"),m=u.find(".cancel"),b=u.find(".yes"),v=f.attr("href"),k=this.$containersArea.find(".dashboard-composer__dashboard-preview__container.active");o(this.$dynamicArea),s.on("click",function(o){o.preventDefault(),d.css("display","inline-block");var t=c.val(),r=c.find("option:selected").text();e.ajax({url:_,data:{type:t},success:function(o){d.hide(),e(a).trigger(e.Event("blockcreateformloaded",{response:o,containerId:n.containerId,blockType:t,blockTypeLabel:r}))}})}),t.sortable({revert:!0,cursor:"move",revertDuration:200,delay:200,helper:function(n,o){{var a=e(o),t=a.find(".dashboard-composer__container__child__edit h4").text().trim();a.find(".dashboard-composer__container__child__edit small").text().trim()}return a.removeClass("dashboard-composer__container__child--expanded"),e('<div class="dashboard-composer__container__child__helper"><h4>'+t+"</h4></div>")},update:function(n,o){var r=[];if(t.find(".dashboard-composer__container__child").each(function(n){var o=e(this),t=o.attr("data-parent-block-id"),i=o.attr("data-block-id");"undefined"!=typeof i&&r.push({id:parseInt(i,10),position:n,parent_id:parseInt(t,10),dashboard_id:a.dashboardId})}),r.length>0){var i=e.Event("blockpositionsupdate");i.disposition=r,e(a).trigger(i)}}}),f.on("click",function(e){e.preventDefault(),f.hide(),u.show()}),b.on("click",function(n){n.preventDefault(),e.ajax({url:v,type:"POST",data:{_method:"DELETE",_sonata_csrf_token:a.csrfTokens.remove},success:function(e){e.result&&"ok"===e.result&&(k.remove(),a.$containerPreviews=a.$dashboardPreview.find(".dashboard-composer__dashboard-preview__container"),a.$dynamicArea.empty(),a.bindDashboardPreviewHandlers())}})}),m.on("click",function(e){e.preventDefault(),u.hide(),f.show()}),h.on("click",function(e){l.toggle()}),r.each(function(){a.controlChildBlock(e(this))})},bindDashboardPreviewHandlers:function(n){var o=this;this.$containerPreviews.each(function(){var n=e(this);n.unbind().on("click",function(a){a.preventDefault();var t=e.Event("containerclick");t.$container=n,e(o).trigger(t)})}).droppable({hoverClass:"hover",tolerance:"pointer",revert:!0,connectToSortable:".dashboard-composer__container__children",drop:function(n,a){var t=a.draggable.attr("data-block-id");if("undefined"!=typeof t){a.helper.remove();var r=e(this),i=parseInt(a.draggable.attr("data-parent-block-id"),10),d=parseInt(r.attr("data-block-id"),10);t=parseInt(t,10),i!==d&&(r.addClass("dropped"),r.on("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(e){r.removeClass("dropped")}),e.ajax({url:o.getRouteUrl("block_switch_parent"),data:{block_id:t,parent_id:d},success:function(n){if(n.result&&"ok"===n.result){a.draggable.remove();var r=e.Event("blockparentswitched");r.previousParentId=i,r.newParentId=d,r.blockId=t,e(o).trigger(r)}}}))}}}),this.$containerPreviews.length>0&&this.loadContainer(void 0==n?this.$containerPreviews.eq(0):this.$containerPreviews.eq(this.$containerPreviews.length-1))},loadContainer:function(n){var o=n.attr("href"),a=n.attr("data-block-id"),t=this;this.$dynamicArea.empty(),this.$containerPreviews.removeClass("active"),n.addClass("active"),e.ajax({url:o,success:function(n){t.$dynamicArea.html(n),e(document).scrollTo(t.$dynamicArea,200,{offset:{top:-100}});var o=e.Event("containerloaded");o.containerId=a,e(t).trigger(o)}})},bindAddContainer:function(){var n=this,o=this.$dashboardPreview.find(".dashboard-composer__block-container-header"),a=o.find(".dashboard-composer__block-container-header__loader"),t=o.find("input"),r=o.find(".dashboard-composer__block-container-header__confirm"),i=r.attr("href");r.on("click",function(o){o.preventDefault(),a.css("display","inline-block");var r=t.val();e.ajax({url:i,data:{name:r},success:function(e){a.hide(),t.val(""),n.$containersArea.append(e),n.$containerPreviews=n.$dashboardPreview.find(".dashboard-composer__dashboard-preview__container"),n.bindDashboardPreviewHandlers(!0)}})})}},n.DashboardComposer=a}(jQuery,window);